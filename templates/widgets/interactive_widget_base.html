<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title if title else 'Widget' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Match main dashboard sophisticated styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100vh;
    }

    /* Dark theme - matches main dashboard */
    body.dark {
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      color: #e0e0e0;
    }

    /* Light theme - professional light gradient */
    body.light {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
      color: #2c3e50;
    }

    .widget-container {
      margin: 0;
      padding: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      width: calc(100% - 0px);
      height: calc(100% - 0px);
    }

    /* Dark theme widget container */
    body.dark .widget-container {
      background: linear-gradient(145deg, #1e1e2e, #252538);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Light theme widget container */
    body.light .widget-container {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.3);
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* Button container styling */
    .time-range-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      padding: 4px 0;
      justify-content: flex-end;
      flex-shrink: 0;
    }
    
    .chart-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* Button styling - Dark theme */
    body.dark .time-range-button {
      background: linear-gradient(145deg, #2d2d3f, #1e1e2e);
      color: #e0e0e0;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    body.dark .time-range-button:hover {
      background: linear-gradient(145deg, #00d4aa, #00b394);
      color: #1a1a2e;
      box-shadow: 0 4px 8px rgba(0,212,170,0.3);
      transform: translateY(-1px);
    }

    body.dark .time-range-button.active {
      background: linear-gradient(145deg, #00d4aa, #00b394);
      color: #1a1a2e;
      box-shadow: 0 4px 8px rgba(0,212,170,0.3);
    }

    /* Button styling - Light theme */
    body.light .time-range-button {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      color: #2c3e50;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    body.light .time-range-button:hover {
      background: linear-gradient(145deg, #00d4aa, #00b394);
      color: white;
      box-shadow: 0 4px 8px rgba(0,212,170,0.2);
      transform: translateY(-1px);
    }

    body.light .time-range-button.active {
      background: linear-gradient(145deg, #00d4aa, #00b394);
      color: white;
      box-shadow: 0 4px 8px rgba(0,212,170,0.2);
    }

    /* Ensure inner chart fills container with proper spacing */
    .chart-wrapper > div {
      height: 100% !important;
      width: 100% !important;
      border-radius: 6px;
      overflow: hidden;
    }

    /* Override Plotly's default styling to match dashboard theme */
    .widget-container .plotly-graph-div {
      background: transparent !important;
      border-radius: 6px;
    }

    /* Custom Plotly modebar styling - Dark theme */
    body.dark .widget-container .modebar {
      background: rgba(23, 23, 35, 0.8) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 4px !important;
    }

    body.dark .widget-container .modebar-btn {
      color: #e0e0e0 !important;
    }

    body.dark .widget-container .modebar-btn:hover {
      background: rgba(0, 212, 170, 0.2) !important;
    }

    /* Custom Plotly modebar styling - Light theme */
    body.light .widget-container .modebar {
      background: rgba(248, 249, 250, 0.9) !important;
      border: 1px solid rgba(0,0,0,0.1) !important;
      border-radius: 4px !important;
    }

    body.light .widget-container .modebar-btn {
      color: #2c3e50 !important;
    }

    body.light .widget-container .modebar-btn:hover {
      background: rgba(0, 212, 170, 0.1) !important;
    }

    /* Dashboard-style title styling - Dark theme */
    body.dark .widget-title {
      color: #00d4aa;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 8px;
    }

    /* Dashboard-style title styling - Light theme */
    body.light .widget-title {
      color: #2c3e50;
      text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 8px;
    }

    /* Style the chart area to match dashboard sections - Dark theme */
    body.dark .widget-container .js-plotly-plot {
      background: rgba(255,255,255,0.03) !important;
      border-radius: 6px !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
    }

    /* Style the chart area to match dashboard sections - Light theme */
    body.light .widget-container .js-plotly-plot {
      background: rgba(0,0,0,0.02) !important;
      border-radius: 6px !important;
      border: 1px solid rgba(0,0,0,0.05) !important;
    }

    /* Additional chart styling to match dashboard look */
    .widget-container .main-svg {
      border-radius: 6px !important;
    }

    /* Override Plotly's text colors to match theme */
    body.dark .widget-container .xtick,
    body.dark .widget-container .ytick,
    body.dark .widget-container .gtitle {
      fill: #e0e0e0 !important;
    }

    body.light .widget-container .xtick,
    body.light .widget-container .ytick,
    body.light .widget-container .gtitle {
      fill: #2c3e50 !important;
    }

    .iframe-note {
      position: absolute;
      left: -10000px; /* visually hidden but present for accessibility testing if needed */
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.1);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      border-radius: 8px;
    }

    body.dark .loading-overlay {
      background: rgba(0,0,0,0.4);
      color: #00d4aa;
    }

    body.light .loading-overlay {
      background: rgba(255,255,255,0.7);
      color: #2c3e50;
    }
  </style>
</head>
<body class="{{ 'dark' if theme == 'dark' else 'light' }}">
  <div class="widget-container">
    <!-- Time range buttons -->
    <div class="time-range-buttons">
      {% if buttons %}
        {% for button_range in buttons %}
          {% if button_range == "7d" %}
            <button class="time-range-button" data-range="7d">7 Days</button>
          {% elif button_range == "8w" %}
            <button class="time-range-button" data-range="8w">8 Weeks</button>
          {% elif button_range == "12w" %}
            <button class="time-range-button" data-range="12w">12 Weeks</button>
          {% elif button_range == "13w" %}
            <button class="time-range-button" data-range="13w">Quarterly</button>
          {% elif button_range == "ytd" %}
            <button class="time-range-button" data-range="ytd">YTD</button>
          {% endif %}
        {% endfor %}
      {% else %}
        <button class="time-range-button" data-range="7d">7 Days</button>
        <button class="time-range-button" data-range="8w">8 Weeks</button>
        <button class="time-range-button" data-range="12w">12 Weeks</button>
        <button class="time-range-button" data-range="13w">Quarterly</button>
        <button class="time-range-button" data-range="ytd">YTD</button>
      {% endif %}
    </div>

    <!-- Chart wrapper -->
    <div class="chart-wrapper">
      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay">
        <div>Loading...</div>
      </div>

      <!-- chart_html includes the div+script and plotlyjs from CDN (include_plotlyjs='cdn') -->
      {{ chart_html|safe }}
    </div>
  </div>

  <div class="iframe-note" aria-hidden="true">This widget page is iframe-ready with interactive time range buttons.</div>

  <script>
    // Get current range from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const currentRange = urlParams.get('range') || '12w';

    // Set active button
    document.querySelectorAll('.time-range-button').forEach(btn => {
      if (btn.dataset.range === currentRange) {
        btn.classList.add('active');
      }

      btn.addEventListener('click', function() {
        const range = this.dataset.range;
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Show loading
        loadingOverlay.style.display = 'flex';

        // Update URL with new range
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('range', range);

        // Reload the page
        window.location.href = newUrl.toString();
      });
    });
  </script>
</body>
</html>