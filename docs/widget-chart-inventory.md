# Widget–Chart Inventory and Widget Mapping

## Overview
This document inventories all charts currently generated by the application code and maps each to a proposed or existing widget endpoint with a parameter schema. The goal is one widget per chart so dashboards and iframes reuse the same endpoints consistently.

## Already implemented widget endpoints
- demo_timeseries → [def demo_timeseries()](widgets/registry.py:204)
- weekly_response_time_trends → [def weekly_response_time_trends()](widgets/registry.py:244)
- volume_daily_historic → [def volume_daily_historic()](widgets/registry.py:327)

## Ticket analytics charts

1) tickets_by_pipeline
- Location: [def _create_pipeline_chart()](ticket_processor.py:389)
- Description: Horizontal bar showing ticket counts per Pipeline.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "pipelines": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Requires column "Pipeline". Uses pre-filtered analysis_df for date range.

2) weekday_weekend_distribution
- Location: [def _create_weekend_distribution_chart()](ticket_processor.py:446)
- Description: Donut chart comparing weekday vs weekend ticket share.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"}
  }
- Notes/assumptions: Requires "Weekend_Ticket" boolean; computed in [def _add_weekend_flag()](ticket_processor.py:128).

3) weekly_response_breakdown
- Location: [def _create_weekly_response_time_chart()](ticket_processor.py:1100) → [def _create_interactive_weekly_chart()](ticket_processor.py:1464)
- Description: Toggleable weekly response-time bars with All vs Weekday vs Weekend series, trend lines, and Median/Mean toggle.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "stat": {"type": "enum", "values": ["median","mean"], "default": "median"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "all"},
    "include_weekend_series": {"type": "bool", "default": false},
    "show_trend": {"type": "bool", "default": true}
  }
- Notes/assumptions: Requires "First Response Time (Hours)" and "Weekend_Ticket". Excludes negative/zero response times.

4) agent_ticket_volume_distribution
- Location: [def _create_interactive_agent_charts()](ticket_processor.py:1865) (volume + pie, first figure)
- Description: Agent ticket volumes (bar) with share (pie).
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Owner column detection via "Case Owner"|"Ticket owner". Volume uses all weekday tickets; name mapping in [def _map_staff_names()](ticket_processor.py:111).

5) agent_response_time_comparison
- Location: [def _create_interactive_agent_charts()](ticket_processor.py:1865) (response-time bars, second figure)
- Description: Grouped bars comparing Average vs Median response time per agent (excludes Live Chat tickets for response durations).
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "stat": {"type": "enum", "values": ["median","mean","both"], "default": "both"},
    "agents": {"type": "list[string]", "default": null},
    "exclude_pipelines": {"type": "list[string]", "default": ["Live Chat "]}
  }
- Notes/assumptions: Needs "First Response Time (Hours)"; Live Chat excluded by processor logic.

6) historic_daily_ticket_volume
- Location: [def _create_historic_daily_volume_chart()](ticket_processor.py:983)
- Description: Daily ticket counts since 2025 with linear trend.
- Data source(s): tickets
- Param schema (matches existing widget):
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "26w"},
    "include_weekends": {"type": "bool", "default": true}
  }
- Notes/assumptions: Implemented as widget volume_daily_historic in [def volume_daily_historic()](widgets/registry.py:327).

## Chat analytics charts

7) chat_weekly_volume_breakdown
- Location: [def _create_weekly_volume_chart()](chat_processor.py:574)
- Description: Weekly total chats with bot and human breakdown bars and total trend line (last 12 weeks by default).
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "series": {"type": "list[enum]", "values": ["total","bot","human","trend"], "default": ["total","bot","human","trend"]}
  }
- Notes/assumptions: Requires "agent_type", "bot_transfer", "chat_creation_date_adt". Uses full dataset for weekly rollups.

8) weekly_bot_satisfaction
- Location: [def _create_weekly_satisfaction_chart()](chat_processor.py:730)
- Description: Weekly satisfaction rate (%) for bot-handled chats with trend.
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"}
  }
- Notes/assumptions: Requires "rating_value" and "has_rating"; converts 1–5 to 0–100%.

9) bot_volume_duration
- Location: [def _create_individual_agent_charts()](chat_processor.py:844) (bot volume & duration subplots)
- Description: Side-by-side bars for bot chat volumes and average duration per bot.
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "bots": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Uses display names via [def _get_display_name()](chat_processor.py:197). Needs "duration_minutes".

10) human_volume_duration
- Location: [def _create_individual_agent_charts()](chat_processor.py:986) (human agent volume & duration subplots)
- Description: Side-by-side bars for human chat volumes and average duration per agent.
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Counts both primary and secondary agent appearances.

11) bot_performance_comparison
- Location: [def _create_bot_performance_charts()](chat_processor.py:1055)
- Description: Composite chart – bot volume (bars), satisfaction rate (line, secondary axis), and pie distribution.
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"},
    "bots": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Requires "has_rating" and "rating_value" for satisfaction; "bot_transfer" for transfer-rate insight text.

12) daily_chat_trends_performance
- Location: [def _create_chat_trends_chart()](chat_processor.py:1172)
- Description: Daily chat volume (bars) with satisfaction and transfer-rate lines (secondary axis).
- Data source(s): chats
- Param schema:
  {
    "source": {"type": "enum", "values": ["chats"], "default": "chats"},
    "range": {"type": "enum", "values": ["all","52w","26w","12w","8w","4w"], "default": "12w"}
  }
- Notes/assumptions: Needs "rating_value" for satisfaction; "bot_transfer" for transfer rate.

## Agent performance (experimental/test HTMLs)
These charts are present in test/demo HTML outputs and represent desired analytics; they are not yet wired as reusable widget endpoints.

13) agent_weekly_response_by_agent
- Location: [enhanced_agent_performance_final.html](enhanced_agent_performance_final.html:136)
- Description: Weekly median response times per agent (multiple line traces).
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null},
    "stat": {"type": "enum", "values": ["median"], "default": "median"}
  }
- Notes/assumptions: Per-agent series; requires "First Response Time (Hours)" and owner mapping.

14) agent_weekly_ticket_volume_by_agent
- Location: [enhanced_agent_performance_final.html](enhanced_agent_performance_final.html:230)
- Description: Weekly ticket counts per agent (multiple line traces).
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Aggregates by owner per week (Mon-start).

15) performance_vs_volume
- Location: [enhanced_agent_performance_final.html](enhanced_agent_performance_final.html:552)
- Description: Dual-axis chart – median response time (bars) vs total tickets (line) per agent.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Requires per-agent median response and counts.

16) pipeline_distribution_by_agent
- Location: [enhanced_agent_performance_final.html](enhanced_agent_performance_final.html:372) and [debug_charts.html](debug_charts.html:116)
- Description: Stacked bars of ticket counts by pipeline per agent.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null},
    "pipelines": {"type": "list[string]", "default": null}
  }
- Notes/assumptions: Requires "Pipeline" and owner; same owner mapping as tickets.

17) pipeline_response_time_heatmap
- Location: [enhanced_agent_performance_final.html](enhanced_agent_performance_final.html:512)
- Description: Heatmap of median response time (hours) by agent × pipeline.
- Data source(s): tickets
- Param schema:
  {
    "source": {"type": "enum", "values": ["tickets"], "default": "tickets"},
    "range": {"type": "enum", "values": ["all","12w","8w"], "default": "12w"},
    "agents": {"type": "list[string]", "default": null},
    "pipelines": {"type": "list[string]", "default": null},
    "stat": {"type": "enum", "values": ["median"], "default": "median"}
  }
- Notes/assumptions: Requires "First Response Time (Hours)" and "Pipeline".

## Implementation Plan
- Already implemented as widgets:
  - [def demo_timeseries()](widgets/registry.py:204)
  - [def weekly_response_time_trends()](widgets/registry.py:244)
  - [def volume_daily_historic()](widgets/registry.py:327)

- Easy (simple aggregation + single-figure; reuse [class BarChart](chart_components.py:348) / [class TimeSeriesChart](chart_components.py:285)):
  - tickets_by_pipeline
  - weekday_weekend_distribution
  - weekly_bot_satisfaction

- Medium (multi-series or subplots; reuse [class MultiSeriesChart](chart_components.py:459) or compose multiple traces):
  - chat_weekly_volume_breakdown
  - bot_volume_duration
  - human_volume_duration
  - agent_ticket_volume_distribution
  - agent_response_time_comparison

- Harder (composite visuals, dual axes, toggles, or heatmaps):
  - weekly_response_breakdown (bar groups + trend + stat toggle; leverage ticket weekly aggregation in [def _create_interactive_weekly_chart()](ticket_processor.py:1464))
  - daily_chat_trends_performance (dual y-axis; reuse chat daily stats from [def _create_chat_trends_chart()](chat_processor.py:1172))
  - performance_vs_volume (dual-axis per-agent)
  - pipeline_distribution_by_agent (stacked bars per agent × pipeline)
  - pipeline_response_time_heatmap (pivot to matrix; feed [class Heatmap] concept via [class MultiSeriesChart](chart_components.py:459) or custom go.Heatmap)

- Helper utilities to reuse:
  - Ticket preprocessing: [def _convert_timezone()](ticket_processor.py:88), [def _add_weekend_flag()](ticket_processor.py:128), [def _calc_first_response()](ticket_processor.py:254)
  - Chat preprocessing: [def _normalize_columns()](chat_processor.py:149), [def process_data()](chat_processor.py:90)
  - Chart components: [class ChartComponent](chart_components.py:79), [class TimeSeriesChart](chart_components.py:285), [class BarChart](chart_components.py:348), [class MultiSeriesChart](chart_components.py:459)

- Suggested new widget endpoints to add next (with minimal glue around existing aggregations):
  - tickets_by_pipeline
  - weekday_weekend_distribution
  - chat_weekly_volume_breakdown
  - weekly_bot_satisfaction
  - agent_ticket_volume_distribution
  - agent_response_time_comparison
  - bot_volume_duration
  - human_volume_duration
  - weekly_response_breakdown
  - daily_chat_trends_performance
  - pipeline_distribution_by_agent
  - pipeline_response_time_heatmap
  - performance_vs_volume

### Dependencies and assumptions (by data source)
- Tickets:
  - Required columns: "Create date" (tz-aware), "First Response Time (Hours)", "Pipeline", "Case Owner"|"Ticket owner", "Weekend_Ticket".
  - Weekend classification defined in [def _add_weekend_flag()](ticket_processor.py:128) (Fri 6pm–Mon 5am EDT).
  - Response time excludes negative/zero; some charts exclude "Live Chat " pipeline for response stats.
- Chats:
  - Required fields after normalization: "chat_creation_date_adt", "agent_type", "primary_agent"/"secondary_agent", "display_agent", "has_rating", "rating_value", "duration_minutes", "bot_transfer".
  - Timezone handling per [def process_data()](chat_processor.py:90) and [def _normalize_columns()](chat_processor.py:149).

## Ready-to-implement widget checklist
- [ ] tickets_by_pipeline
- [ ] weekday_weekend_distribution
- [ ] chat_weekly_volume_breakdown
- [ ] weekly_bot_satisfaction
- [ ] agent_ticket_volume_distribution
- [ ] agent_response_time_comparison
- [ ] bot_volume_duration
- [ ] human_volume_duration
- [ ] weekly_response_breakdown
- [ ] daily_chat_trends_performance
- [ ] pipeline_distribution_by_agent
- [ ] pipeline_response_time_heatmap
- [ ] performance_vs_volume